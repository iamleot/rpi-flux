name: Validate Kubernetes configuration files

'on':
  push:
    branches:
      - main
  pull_request:

env:
  KUSTOMIZE_FLAGS: "--load-restrictor=LoadRestrictionsNone --reorder=legacy"
  KUBECONFORM_FLAGS: "-ignore-missing-schemas -strict -schema-location default -schema-location /tmp/flux-crd-schemas -verbose"
  KUBECONFORM_VERSION: "v0.4.13"

jobs:
  validate:
    name: Validate Kubernetes configuration files
    runs-on: 'ubuntu-latest'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Install kubeconform
        run: |
          mkdir -p "${HOME}/.local/bin"
          curl -sL "https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz" | tar xzf - -C "${HOME}/.local/bin" kubeconform
      - name: Validating Kubernetes configuration files
        run: |
          make validate
